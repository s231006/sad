<script>
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const detectButton = document.getElementById('detect-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsArea = document.getElementById('results-area');

        let base64ImageData = ''; // Store the Base64 image data
        let currentMimeType = 'image/png'; // Default MIME type

        /**
         * Resizes an image to a maximum dimension while maintaining aspect ratio,
         * then converts it to a Base64 data URL.
         * @param {File} file The image file to resize.
         * @param {number} maxWidth The maximum width for the resized image.
         * @param {number} maxHeight The maximum height for the resized image.
         * @returns {Promise<string>} A promise that resolves with the Base64 data URL of the resized image.
         */
        async function resizeImage(file, maxWidth, maxHeight) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        // Create a canvas element
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');

                        // Draw the image onto the canvas
                        ctx.drawImage(img, 0, 0, width, height);

                        // Get the data URL from the canvas
                        // Use the original file's MIME type if possible, otherwise default to image/jpeg for better compression
                        const outputMimeType = file.type && file.type.startsWith('image/') ? file.type : 'image/jpeg';
                        const quality = 0.9; // Adjust quality for JPEG output
                        const dataUrl = canvas.toDataURL(outputMimeType, quality);
                        currentMimeType = outputMimeType; // Update the global mime type

                        resolve(dataUrl);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Event listener for image file selection
        imageUpload.addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (file) {
                // Resize the image to a maximum of 1000 pixels (either width or height)
                const resizedDataUrl = await resizeImage(file, 1000, 1000);

                imagePreview.src = resizedDataUrl;
                imagePreview.style.display = 'block'; // Show the image preview

                // Get only the base64 part from the resized data URL
                base64ImageData = resizedDataUrl.split(',')[1];
                imagePreview.dataset.mimeType = currentMimeType; // Store the actual mime type used for the canvas output

                detectButton.disabled = false; // Enable the detect button
                resultsArea.innerHTML = '<p class="text-gray-600">Image loaded and resized. Click "Detect Food" to analyze.</p>';
            } else {
                imagePreview.src = '#';
                imagePreview.style.display = 'none';
                base64ImageData = '';
                imagePreview.dataset.mimeType = '';
                detectButton.disabled = true;
                resultsArea.innerHTML = '<p class="text-gray-600">Upload an image and click "Detect Food" to see the results.</p>';
            }
        });

        // Event listener for the detect button
        detectButton.addEventListener('click', async function() {
            // OpenRouter API Key provided by the user (decoded from Base64)
            const apiKey = atob("c2stb3ItdjEtYTVkYTg1ZjI0MDBjZWE1NWQ5NWQyY2MwMjU1Y2Y1YTEzOWM2YzBhNTVmZWJlMDQwZGM5MTM3MzJkM2ViN2QwMQ==");

            if (!base64ImageData) {
                resultsArea.innerHTML = '<p class="text-red-500">Please upload an image first.</p>';
                return;
            }

            // Show loading indicator and disable button
            loadingIndicator.style.display = 'flex';
            detectButton.disabled = true;
            resultsArea.innerHTML = ''; // Clear previous results

            try {
                const apiUrl = "https://openrouter.ai/api/v1/chat/completions";
                // Model is google/gemma-3-27b-it:free
                const modelName = "google/gemma-3-27b-it:free";

                // Updated prompt to include food name, ingredient list, nutrients, and health for elderly, separated by sections
                const prompt = "Based on the image, provide the following information:\n1. Food Name:\n2. Ingredients (short, comma-separated list):\n3. Key Nutrients (short, comma-separated list):\n4. Is this food generally healthy for elderly people? (Yes/No and a very brief reason).";
                const mimeType = imagePreview.dataset.mimeType || 'image/png'; // Use detected mime type or fallback

                const payload = {
                    model: modelName,
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: prompt },
                                {
                                    type: "image_url",
                                    image_url: {
                                        url: `data:${mimeType};base64,${base64ImageData}`
                                    }
                                }
                            ]
                        }
                    ]
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();

                if (result.choices && result.choices.length > 0 &&
                    result.choices[0].message && result.choices[0].message.content) {
                    const text = result.choices[0].message.content;
                    // Replace newlines with <br> for HTML display
                    resultsArea.innerHTML = `<p class="text-gray-800 fade-in">${text.replace(/\n/g, '<br>')}</p>`;
                } else {
                    resultsArea.innerHTML = '<p class="text-red-500">No food items or nutrients detected or unexpected API response structure from OpenRouter.</p>';
                }
            } catch (error) {
                console.error('Error detecting food:', error);
                resultsArea.innerHTML = `<p class="text-red-500">Error: ${error.message}. Please try again.</p>`;
            } finally {
                // Hide loading indicator and re-enable button
                loadingIndicator.style.display = 'none';
                detectButton.disabled = false;
            }
        });
    </script>
